#! /bin/bash
set -eu

DATE=$(date +"%y%m%d")
SHA=$(git rev-parse --short HEAD 2>/dev/null || echo "UNKNOWN")
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(cpp|hpp|h|c)$')

for FILE in $FILES; do
  awk -v d="$DATE" -v sha="$SHA" '
    {
      if ($0 ~ /^\/\/[[:space:]]*Version:/) {
        print "// Version: " d " (commit " sha ")"
      } else {
        print
      }
    }
  ' "$FILE" > "$FILE.tmp" && mv "$FILE.tmp" "$FILE"
  git add "$FILE"
done
